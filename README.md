# Incepiton Mysql

:apple: A web platform designed for MySQL Inception.

:anchor: åŸºäºInceptionçš„SQLè‡ªåŠ¨åŒ–å®¡æ ¸å¹³å°ã€‚

![Travis](https://img.shields.io/badge/python-v3.x-orange.svg)
![Travis](https://img.shields.io/badge/flask-v0.12.2-orange.svg)
![Travis](https://img.shields.io/badge/mysql-v5.7-orange.svg)
![Travis](https://img.shields.io/badge/celery-v4.0.1-orange.svg)
![Travis](https://img.shields.io/badge/latest--version-v1.0.0-green.svg)
![Travis](https://img.shields.io/badge/downloads-1k-green.svg)
![Travis](https://img.shields.io/badge/license-MIT-blue.svg)


## åŠŸèƒ½ä¸€è§ˆ

### ç™»é™†

ç™»é™†æµç¨‹åˆ†ä¸¤ç§ï¼Œä¸€ç§å¯¹æ¥ä¼ä¸šå†…éƒ¨çš„OpenLDAPï¼Œå®ç°è´¦å·ç»Ÿä¸€ç®¡ç†ã€‚å¦ä¸€ç§æ˜¯ç›´æ¥èµ°æ•°æ®åº“ã€‚ä¸¤ç§æ–¹å¼çš„é€‰æ‹©é€šè¿‡<code>config.py</code>ä¸­çš„<code>LDAP_ON_OFF</code>æ§åˆ¶

### æƒé™ç®¡ç†

åˆ†ä¸‰ç§è§’è‰²ã€‚Devï¼Œå¼€å‘äººï¼›Auditï¼Œå®¡æ ¸äººï¼›Adminï¼Œç®¡ç†å‘˜

### DevåŠŸèƒ½

- æ•°æ®åº“å®ä¾‹æŸ¥çœ‹ã€ç”³è¯·ã€å–æ¶ˆ
- å·¥å•æŸ¥çœ‹ã€ç”³è¯·ã€å–æ¶ˆã€ä¿®æ”¹
- å·¥å•çŠ¶æ€ã€æ•°ç›®å¯è§†åŒ–å±•ç¤º

### AuditåŠŸèƒ½

- æ•°æ®åº“å®ä¾‹æŸ¥çœ‹ã€åˆ†é…ã€æ’¤é”€
- å·¥å•æŸ¥çœ‹ã€å–æ¶ˆã€é©³å›ã€æ‰§è¡Œã€å®šæ—¶æ‰§è¡Œ
- æ”¯æŒ pt-online-schema-change å·¥å…·ï¼Œå¤§è¡¨å¯è¿›è¡Œ online DDLæ“ä½œ
- SQLæ‰§è¡Œè¿›åº¦å®æ—¶è·å–ï¼Œä¸­é€”å¯åœæ­¢ï¼Œéœ€æ‰‹åŠ¨æ¸…é™¤è§¦å‘å™¨å’Œä¸´æ—¶è¡¨

### AdminåŠŸèƒ½

- æ•°æ®åº“å®ä¾‹æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤
- ç”¨æˆ·æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤

### é‚®ä»¶é€šçŸ¥

## é‡è¦åŠŸèƒ½ä»‹ç»

### æ”¯æŒåˆ†è¡¨æ“ä½œ

![åˆ†è¡¨æ“ä½œ](https://github.com/Tianny/incepiton_mysql/blob/master/images/work_create.png)

### è‡ªåŠ¨å®¡æ ¸

å‘èµ·SQLä¸Šçº¿ï¼Œç”±[Inception](https://github.com/mysql-inception/inception)è‡ªåŠ¨å®¡æ ¸ï¼Œè‡ªåŠ¨å®¡æ ¸æˆåŠŸåï¼Œæäº¤è‡³Auditã€‚

![è‡ªåŠ¨å®¡æ ¸ç»“æœ](https://github.com/Tianny/incepiton_mysql/blob/master/images/auto_check.png)

### å®¡æ ¸äººæ“ä½œ
![å®¡æ ¸äººæ“ä½œ](https://github.com/Tianny/incepiton_mysql/blob/master/images/audit_operate.png)

### SQLæ‰§è¡Œè¿›åº¦å®æ—¶è·å–

åªæœ‰èµ°pt-oscä¿®æ”¹å¤§è¡¨æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºæ‰§è¡Œè¿›åº¦ã€‚å…·ä½“å¤šå¤§çš„è¡¨èµ°pt-oscï¼Œå¯ä»¥é€šè¿‡ Inception æ¥é…ç½®ï¼Œå…·ä½“å‚è€ƒ [Inceptionæ–‡æ¡£](http://mysql-inception.github.io/inception-document/)ã€‚
![è¿›åº¦è·å–](https://github.com/Tianny/incepiton_mysql/blob/master/images/percent.png)

### å®šæ—¶ä»»åŠ¡

å®šæ—¶ä»»åŠ¡å¯è®¾ç½®ã€å–æ¶ˆ
![å®šæ—¶ä»»åŠ¡](https://github.com/Tianny/incepiton_mysql/blob/master/images/timer.png)


### å·¥å•å›¾è¡¨
![å›¾è¡¨](https://github.com/Tianny/incepiton_mysql/blob/master/images/chart.png)

### å›æ»šæ“ä½œ
![å›æ»š](https://github.com/Tianny/incepiton_mysql/blob/master/images/result.png)

## èµ„æºçŠ¶æ€è¯´æ˜

- 0ï¼šSuccessï¼ŒæˆåŠŸ
- 1ï¼šPendingï¼Œæœªå¤„ç†
- 2ï¼šDev Cancelledï¼Œå¼€å‘äººå–æ¶ˆ
- 3ï¼šAudit Cancelledï¼Œå®¡æ ¸äººå–æ¶ˆ

## å·¥å•çŠ¶æ€è¯´æ˜

- 0ï¼šSuccessï¼ŒæˆåŠŸ
- 1ï¼šPendingï¼Œ å¸¦äººå·¥å®¡æ ¸
- 2ï¼šCheck Failedï¼Œè‡ªåŠ¨å®¡æ ¸å¤±è´¥
- 3ï¼šExecutingï¼Œæ‰§è¡Œä¸­
- 4ï¼šErrorï¼Œæ‰§è¡Œå¼‚å¸¸
- 5ï¼šDev Cancelledï¼Œå¼€å‘äººå–æ¶ˆ
- 6ï¼šAudit Cancelledï¼Œå®¡æ ¸äººå–æ¶ˆ
- 7ï¼šAudit Rejectedï¼Œå®¡æ ¸äººé©³å›
- 8ï¼šTimerï¼Œå®šæ—¶ä»»åŠ¡

## éƒ¨åˆ†å¼€å‘è¯´æ˜

1. Inceptionç¼–è¯‘å®‰è£…ï¼Œè¯·ä½¿ç”¨ bison 2.6 ä»¥ä¸‹ç‰ˆæœ¬

2. è¯·æ³¨æ„ Python3 å’Œ Python2 ç¼–ç ä¸åŒ

3. å¯¹æ¥OpenLDAPï¼Œä½¿ç”¨äº†[flask-simpleLDAP](http://flask-simpleldap.readthedocs.io/en/latest/)æ‰©å±•ï¼Œä¸ºäº†å…¼å®¹ python3ï¼Œæœ‰ä¸€å¤„æºç éœ€è¦ä¿®æ”¹ï¼Œ__init.__py ç¬¬153è¡Œï¼ŒæŒ‰å¦‚ä¸‹ä¿®æ”¹
![ldap](https://github.com/Tianny/incepiton_mysql/blob/master/images/flask-ldap-modify.png)

4. ä¸ºäº†å…¼å®¹ Inception è¿”å›çš„ä¿¡æ¯ï¼ŒpyMysql éœ€è¦ä¿®æ”¹ä¸¤å¤„æºç ã€‚
- python3ä½¿ç”¨çš„pyMysqlæ¨¡å—é‡Œå¹¶æœªå…¼å®¹inceptionè¿”å›çš„serverä¿¡æ¯ï¼Œå› æ­¤éœ€è¦æ·»åŠ 
![2](https://github.com/Tianny/incepiton_mysql/blob/master/images/pymsql_modify_2.png)

- python3çš„pyMysqlæ¨¡å—ä¼šå‘inceptionå‘é€SHOW WARNINGSè¯­å¥ï¼Œå¯¼è‡´inceptionè¿”å›ä¸€ä¸ª"Must start as begin statement"é”™è¯¯ã€‚
![1](https://github.com/Tianny/incepiton_mysql/blob/master/images/pymsql_modify_1.png)

5. Celery æœ€æ–°ç‰ˆæœ¬å³4.1.0 å­˜åœ¨æ—¶åŒºè®¾ç½®BUGï¼Œå…·ä½“è¯¦è§[TimeZone Bug](https://github.com/celery/celery/pull/4173/)ï¼Œå…·ä½“å°±æ˜¯è®¾ç½®äº† Asia/Shanghaiï¼ŒETA æ‰§è¡Œçš„æ—¶é—´æ¯”æ­£å¸¸ä¸œå…«åŒºæ—¶é—´åˆå¤šäº†8ä¸ªå°æ—¶ï¼Œä¸è¿‡æˆ‘å·²ç»åœ¨ä»£ç é‡Œå¤„ç†è¿‡äº†ã€‚å®˜æ–¹ä¼šåœ¨ä¸‹ä¸ªç‰ˆæœ¬ä¿®å¤ã€‚

## ä½¿ç”¨è¯´æ˜

- åˆ›å»ºè¡¨ç»“æ„
```python
python manage.py shell
db.creat_all()
```
- åˆ›å»ºç”¨æˆ·

å¦‚æœæ˜¯èµ°OpenLDAPçš„è¯ï¼Œä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·ï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“ä¸­ã€‚

ä¸èµ°OpenLDAPï¼Œé€šè¿‡ç™»å½•é¡µé¢çš„æ³¨å†ŒåŠŸèƒ½å³å¯ã€‚å½“ç„¶ä¹Ÿå¯æ‰‹åŠ¨å»æ•°æ®åº“é‡Œæ·»åŠ ã€‚

- å¯åŠ¨ Celery

Celery éœ€è¦ä½¿ç”¨ broker å’Œ backendï¼Œ æˆ‘è¿™é‡Œéƒ½é‡‡ç”¨äº† redisã€‚å…·ä½“ Celery çš„ä½¿ç”¨ æŸ¥çœ‹[Celeryæ–‡æ¡£](http://docs.celeryproject.org/en/latest/index.html#)

```bash
    celery worker -A celery_runner --logleve=info --statedb=/tmp/worker.state
```

æ³¨æ„ä¸Šé¢çš„ <code>--statedb=/tmp/worker.state</code>ï¼Œæ’¤é”€çš„å®šæ—¶ä»»åŠ¡å‡è¢« Celery ä¿å­˜åœ¨é‡Œé¢ï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦ä¸¢å¤±ã€‚

- éƒ¨ç½²

Flaskéƒ¨ç½²æ–¹å¼è¯·å‚è€ƒ[éƒ¨ç½²](http://tianny.cc/Flask-Gunicorn-Nginx%E9%83%A8%E7%BD%B2/)

- æœ¬åœ°æµ‹è¯•

```bash
python manage.py runserver --threaded
```

## æ”¹è¿›

> å¦‚æœå¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ‚¨å¯ä»¥ç‚¹å³ä¸Šè§’ "Star" æ”¯æŒä¸€ä¸‹ è°¢è°¢ï¼ ^_^

> å¦‚æœ‰é—®é¢˜è¯·ç›´æ¥åœ¨ Issues ä¸­æï¼Œæˆ–è€…æ‚¨å‘ç°é—®é¢˜å¹¶æœ‰éå¸¸å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæ¬¢è¿ PR ğŸ‘